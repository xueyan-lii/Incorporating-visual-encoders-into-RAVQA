# Copyright (c) Meta Platforms, Inc. and affiliates.
# This software may be used and distributed according to the terms of the Llama 2 Community License Agreement.
# use GPU, BLIP2 environment
# torchrun --nproc_per_node 1 models/LLAMA2/example_text_completion.py     --ckpt_dir /home/xl544/rds/rds-cvnlp-hirYTW1FQIw/shared_space/llama2/llama/llama-2-7b/     --tokenizer_path /home/xl544/rds/rds-cvnlp-hirYTW1FQIw/shared_space/llama2/llama/tokenizer.model     --max_seq_len 128 --max_batch_size 4
import fire
from llama import Llama

def main(
    ckpt_dir: str,
    tokenizer_path: str,
    temperature: float = 0.6,
    top_p: float = 0.9,
    max_seq_len: int = 128,
    max_gen_len: int = 64,
    max_batch_size: int = 4,
):
    generator = Llama.build(
        ckpt_dir=ckpt_dir,
        tokenizer_path=tokenizer_path,
        max_seq_len=max_seq_len,
        max_batch_size=max_batch_size,
    )

    prompts = [
        # For these prompts, the expected answer is the natural continuation of the prompt
        "Answer the question according to the context and answer candidates. Each answer candidate is associated with a confidence score within a bracket. The true answer may not be included in the candidates.  Context: a group of horses standing in a field next to a pond. Question: Name the place shown in this picture? Candidates: farm (0.795), ranch (0.767), stable (0.756),  Answer: ranch Context: a bird standing on a branch in a tree. Question: Name this type of four letter animal? Candidates: bird (0.861), pheasant (0.816), crow (0.805), rooster (0.797),  Answer: bird Context: a man walking on the beach with a red surfboard. Question: Name the material carried by the man? Candidates: surfboard (0.859), board (0.832),  Answer: surfboard Context: a couple of men sitting on a couch with a video game controller. Question: Name the dish the man is eating? Candidates: chip (0.814), nacho (0.787), popcorn (0.769),  Answer: chip Context: a vase of flowers sitting on a window sill. Question: What state does the plant look like? Candidates: texas (0.782), california (0.761), nevada (0.758), florida (0.756), idaho (0.75), georgia (0.75), ohio (0.746), washington (0.742), oregon (0.741), hawaii (0.733), missouri (0.733), az (0.731), ny (0.729),  Answer: texas Context: a fighter jet flying over a body of water. Question: How high do you think this is? Candidates: 30000 feet (0.806), 40000 feet (0.765), 50000 feet (0.758), 100000 feet (0.728), 30 (0.724),  Answer: 40000 feet Context: a couple of green buses parked on the side of the street. Question: What season do you think this is? Candidates: fall (0.844), autumn (0.817),  Answer: autumn Context: a person and a dog on the beach at sunset. Question: What time of day might this be? Candidates: sunset (0.827), even (0.816),  Answer: sunset Context: a white car parked on the side of a street. Question: What is the make of this car? Candidates: ford (0.896), honda (0.893), suv (0.88), toyota (0.877), volvo (0.868),  Answer: ford Context: a man sitting in front of a herd of sheep. Question: How many do you think it is? Candidates: 35 (0.748), 20 (0.702),  Answer: 35 Context: a black bird with a red beak standing on the beach. Question: Why is the water where it is? Candidates: tide (0.768),  Answer: tide Context: a bathroom with a toilet and a toilet paper dispenser. Question: What do you do in this room? Candidates: urinate (0.865), pee (0.847), toilet (0.818), flush (0.813),  Answer: urinate Context: a large tractor is parked in the dirt. Question: What is the use for this vehicle? Candidates: dig (0.853),  Answer: dig Context: a table with several trays of food on it. Question: What is all of this food for? Candidates: party (0.844), picnic (0.837), eat (0.791),  Answer: picnic Context: an old blue van parked next to a stop sign. Question: What is the make of this vehicle? Candidates: volkswagen (0.866), van (0.822),  Answer: volkswagon Context: a bathroom with a toilet and a shower. Question: What do people do in this room? Candidates: shower (0.844), urinate (0.843), bathroom (0.842), poop (0.833), pee (0.83), wash hand (0.829), bath (0.823), wash (0.817),  Answer: poop Context: a group of people playing a game of frisbee in a park. Question: What is the name of this game? Candidates: frisbee (0.836),  Answer: frisbee Context: a man throwing a frisbee at a metal structure. Question: What is the name of this game? Candidates: disc golf (0.835),  Answer: disc golf Context: a living room with a couch and a chair and a mirror. Question: What can you do in this room? Candidates: watch tv (0.837), relax (0.811), read (0.795), eat (0.795), sit (0.792),  Answer: sit Context: a man riding on the back of a brown horse. Question: What type of event could this be? Candidates: horse race (0.827), equestrian (0.824), polo (0.813), rodeo (0.807), horse show (0.804), race (0.795),  Answer: equestrian Context: a bathroom with a plant in the middle of it. Question: Name the type of plant this is? Candidates: fern (0.836), succulent (0.832), wall (0.828), house (0.82), vine (0.814),  Answer: ",
        "Answer the question according to the context and answer candidates. Each answer candidate is associated with a confidence score within a bracket. The true answer may not be included in the candidates.  Context: a woman riding a wave on a surfboard in the ocean. Question: What does this woman need to wear to do this? Candidates: swimsuit (0.932), bath suit (0.921), wetsuit (0.902),  Answer: bath suit Context: a catcher in a baseball game throwing a ball. Question: What is this person about to do with the ball? Candidates: pitch (0.868), throw (0.861), throw it (0.835),  Answer: throw it Context: a young boy wearing a tie sitting in a wooden chair. Question: What is the cultural background of people with red hair? Candidates: irish (0.848), blond (0.799), white (0.788),  Answer: irish Context: a train yard with trains and buildings in the background. Question: What is the name of the person that designed these? Candidates: george stephenson (0.823), engineer (0.813), graff (0.811), samuel fox (0.8), thomas edison (0.795), richard trevithick (0.788), thomas elmo (0.787), frederick graff (0.782), thomas elmslie (0.78), eno (0.771), thomas jones (0.766), thomas joyce (0.763), garrett morgan (0.763),  Answer: george stephenson Context: a baseball player holding a bat on a field. Question: What was the man trying to do with the stick? Candidates: hit (0.824), bat (0.784),  Answer: hit ball Context: a red double decker bus driving down a street. Question: What would one use to get to the second level? Candidates: stair (0.85), staircase (0.815), lift (0.795), ride (0.778), tour (0.775), elevator (0.772),  Answer: stair Context: a clock on the side of a building. Question: What can you tell by looking at the square object? Candidates: time (0.839),  Answer: time Context: a large brown bear walking through a forest. Question: What likes honey and lives in the woods? Candidates: bear (0.849), hunt (0.754),  Answer: bear Context: a dirty bathroom with a toilet and a sink. Question: What can you do to protect yourself from this environment? Candidates: leave (0.844),  Answer: leave Context: two women playing a video game in front of a television. Question: What is the name of this game they are playing? Candidates: wii (0.817),  Answer: wii box Context: a couple of men in suits looking at a tablet. Question: What device are the two men in the photo using? Candidates: tablet (0.886),  Answer: tablet Context: a person holding a hot dog with ketchup and mustard. Question: What is the name of this style of hot dog? Candidates: chicago (0.873), swiss (0.855), st louis (0.853), kansas city (0.841), philly (0.833), frankfurter (0.824), ball park (0.823), kentucky (0.82),  Answer: chicago Context: a woman standing on the sidewalk with her luggage. Question: What might this woman's trousers be made of? Candidates: denim (0.881), cotton (0.837),  Answer: denim Context: an old rusted out train sitting on the tracks. Question: What is the cause of the color of the vehicle? Candidates: rust (0.892),  Answer: rust Context: a group of people hiking up a snow covered mountain. Question: What are the things called that are in their hands? Candidates: pole (0.878), stick (0.787),  Answer: pole Context: a young girl cutting a man's hair with a pair of scissors. Question: What is the name of the style of beard? Candidates: goatee (0.897), short (0.87),  Answer: goatee Context: a large boat in the water near a city. Question: What is the name for this type of waterway? Candidates: canal (0.809), river (0.793), ferry (0.78),  Answer: canal Context: a young girl riding on the back of a brown horse. Question: What type of shoe is person in this picture wearing? Candidates: boot (0.857),  Answer: boot Context: a white bus driving down a city street. Question: What is the state of the business on the left? Candidates: philippines (0.741), open (0.726), new york time (0.696), phoenix (0.688),  Answer: open Context: a dog laying on the floor with a water bottle. Question: What was the type of plastic in the dogs mouth? Candidates: bottle (0.819), water (0.773), plastic (0.764),  Answer: bottle Context: a man in a tuxedo walking down a city street. Question: What could this gentleman be carrying in that red bag? Candidates: book (0.853), bag (0.841), newspaper (0.817), luggage (0.814), suitcase (0.807), carry thing (0.807), carry on (0.804),  Answer: "
    ]
    results = generator.text_completion(
        prompts,
        max_gen_len=max_gen_len,
        temperature=temperature,
        top_p=top_p,
    )
    for prompt, result in zip(prompts, results):
        print(prompt)
        print(f"> {result['generation']}")
        print("\n==================================\n")


if __name__ == "__main__":
    fire.Fire(main)
